name: Haskell CI

on:
  push:
    branches:
      - v0.7.3
  pull_request:

jobs:
  build:
    name: GHC ${{ matrix.name }}
    env:
      CABAL_REINIT_CONFIG: y
      LC_ALL: C.UTF-8

      ENABLE_INSTALL: "n"

      STACK_UPGRADE: "y"

      CABAL_CHECK_RELAX: y
      CABAL_NO_SANDBOX: y
      CABAL_HACKAGE_MIRROR: hackage.haskell.org:http://hackage.fpcomplete.com

      PACKCHECK_LOCAL_PATH: "./packcheck.sh"
      PACKCHECK_GITHUB_URL: "https://raw.githubusercontent.com/harendra-kumar/packcheck"
      PACKCHECK_GITHUB_COMMIT: "563702bd02c41343dcd3dfcfef0845ca428a9240"

      BUILD: ${{ matrix.build }}
      GHCVER: ${{ matrix.ghc_version }}
      RESOLVER: ${{ matrix.resolver }}
      CABAL_BUILD_OPTIONS: ${{ matrix.cabal_build_options }}
      CABAL_BUILD_TARGETS: ${{ matrix.cabal_build_targets }}
      CABAL_PROJECT: ${{ matrix.cabal_project }}
      STACK_BUILD_OPTIONS: ${{ matrix.stack_build_options }}
      DISABLE_DOCS: ${{ matrix.disable_docs }}
      SDIST_OPTIONS: ${{ matrix.sdist_options }}
      DISABLE_SDIST_BUILD: ${{ matrix.disable_sdist_build }}
      DISABLE_DIST_CHECKS: ${{ matrix.disable_dist_checks }}
      DISABLE_SDIST_GIT_CHECK: "y"

      INSTALL_LIBSDL: ${{ matrix.install_libsdl }}

    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        name:
          - 9.4.5
          - 9.2.8
          - 8.10.2+macOS
          - 8.8.3+inspection+no-fusion-plugin+Werror
          - 8.10+stack+lts-17
          - 8.6.5+no-fusion-flag
          - 8.6.5+streamk
          - 8.4.4+debug
        include:
          - name: 9.4.5
            ghc_version: 9.4.5
            build: cabal
            cabal_version: 3.8.1.0
            disable_sdist_build: "y"
            ignore_error: false
            runner: ubuntu-latest
          - name: 9.2.8
            ghc_version: 9.2.8
            build: cabal
            cabal_version: 3.6.2.0
            disable_sdist_build: "y"
            ignore_error: false
            runner: ubuntu-latest
          - name: 8.10.2+macOS
            ghc_version: 8.10.2
            build: cabal
            cabal_version: 3.6.2.0
            disable_sdist_build: "y"
            runner: macos-latest
          - name: 8.8.3+inspection+no-fusion-plugin+Werror
            ghc_version: 8.8.3
            build: cabal
            cabal_version: 3.6.2.0
            cabal_project: cabal.project.ci
            cabal_build_options: "--flag inspection"
            runner: ubuntu-latest
          - name: 8.10+stack+lts-17
            build: stack
            resolver: lts-17
            stack_build_options: "--flag streamly:examples-sdl"
            cabal_version: 3.6.2.0
            install_libsdl: "y"
            sdist_options: "--ignore-check"
            runner: ubuntu-latest
          - name: 8.6.5+streamk
            ghc_version: 8.6.5
            build: cabal
            cabal_version: 3.6.2.0
            cabal_build_options: "--flag streamk"
            runner: ubuntu-latest
          - name: 8.6.5+no-fusion-flag
            ghc_version: 8.6.5
            build: cabal
            cabal_version: 3.6.2.0
            runner: ubuntu-latest
          - name: 8.4.4+debug
            ghc_version: 8.4.4
            build: cabal-v2
            cabal_version: 3.2
            cabal_build_options: "--flag debug"
            runner: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - uses: haskell/actions/setup@v1
      with:
        ghc-version: ${{ matrix.ghc_version }}
        cabal-version: ${{ matrix.cabal_version }}

    - uses: actions/cache@v1
      name: Cache ~/.cabal
      with:
        path: ~/.cabal
        key: ${{ runner.os }}-${{ matrix.ghc_version }}-cabal

    - name: Download packcheck
      run: |
        # If a custom stack-yaml is specified, replace the default with that
        if test -e "$STACK_YAML"; then rm -f stack.yaml && ln -sv $STACK_YAML stack.yaml; else true; fi
        unset STACK_YAML

        # Install libsdl if needed
        if test ! -z "$INSTALL_LIBSDL"; then sudo apt-get install -y libsdl1.2-dev; fi;

        # Get packcheck if needed
        CURL=$(which curl)
        PACKCHECK_URL=${PACKCHECK_GITHUB_URL}/${PACKCHECK_GITHUB_COMMIT}/packcheck.sh
        if test ! -e "$PACKCHECK_LOCAL_PATH"; then $CURL -sL -o "$PACKCHECK_LOCAL_PATH" $PACKCHECK_URL; fi;
        chmod +x $PACKCHECK_LOCAL_PATH

    - name: Run packcheck
      run: |
        bash -c "$PACKCHECK_LOCAL_PATH $BUILD"
